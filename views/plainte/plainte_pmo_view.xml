<odoo>

  <record id="plainte_pmo_view_search" model="ir.ui.view">
    <field name="name">plainte.pmo.view.search</field>
    <field name="model">mgp.plainte</field>
    <field name="arch" type="xml">
      <search string="Recherche des tickets">
        <field name="reference" string="Ticket n°"/>
        <field name="date_appel"/>
        <field name="date_event"/>
        <field name="fokontany_id"/>
        <field name="commune_id"/>
        <field name="genre"/>
        <field name="tranche_id" />
        <field name="education_id" />
        <field name="categorie_id" string="Catégorie de plainte"/>
        <field name="composante_id" string="Composante de plainte"/>
        <field name="ennonce" />
        <field name="situation" string="Situation d'appel"/>
        <field name="resultat" />
        <field name="statut" />
        <field name="response_complete" string="Réponse complète"/>

        <separator/>
        <filter string='Femme' name='feminin' domain="[('genre', '=', 'feminin')]"/>
        <filter string='Homme' name='masculin' domain="[('genre', '=', 'masculin')]"/>

        <separator string="Statut"/>
        <filter string='Tickets à traiter par PMO' name='state_traitement_pmo' domain="[('statut', '=', 'state_traitement_pmo')]"/>

        <separator string="Résultat"/>
        <filter string='Satisfait' name='Satisfait' domain="[('resultat', '=', 'satisfait')]"/>
        <filter string='Non satisfait' name='insatisfait' domain="[('resultat', '=', 'insatisfait')]"/>

        <group expand="0" string="Group By">
          <filter string='Genre' name='genre' context="{'group_by':'genre'}"/>
          <filter string='Statut' name='statut' context="{'group_by':'statut'}"/>
          <filter string='Resultat' name='resultat' context="{'group_by':'resultat'}"/>
        </group>
      </search>
    </field>
  </record>

  <!-- explicit list view definition -->
  <record id="plainte_pmo_list_view" model="ir.ui.view">
    <field name="name">Plaintes.list</field>
    <field name="model">mgp.plainte</field>
    <field name="arch" type="xml">
      <tree>
        <field name="reference" string="Ticket" decoration-bf="id > 0"/>
        <field name="date_appel" />
        <field name="categorie_id" />
        <field name="zone" string="Localisation"/>
        <field name="genre" />
        <field name="jours_traitement" string="Nbr-jour(s)"/>
        <field name="statut" 
          decoration-warning="statut == 'state'" 
          decoration-info="statut == 'state_validate_prea'"
          decoration-primary="statut == 'state_traitement_pmo'"
          decoration-it="statut == 'state_eval_response_prea'"
          decoration-muted="statut == 'state_send_response_bpo'"
          decoration-success="statut == 'state_done_bpo'"
          decoration-danger="statut == 'state_invalid'"
          decoration-bf="id > 0"/>
      </tree>
    </field>
  </record>

  <!-- actions opening views on models -->
  <record id="plainte_pmo_form_view" model="ir.ui.view">
    <field name="name">plainte.pmo.form.view</field>
    <field name="model">mgp.plainte</field>
    <field name="arch" type="xml">
      <form>
        <field name="response_complete" invisible="1"/> <!--IMPORTANT -->
        <field name="situation" invisible="1"/> <!--IMPORTANT -->
        <field name="resultat" invisible="1"/> <!--IMPORTANT -->
        <field name="has_response" invisible="1"/> <!--IMPORTANT -->
        <field name="is_reprocessed" invisible="1"/> <!--IMPORTANT -->
        
        <header>
          <!--Group receiver of current user ('is_last_group_receiver', '=', False) -->
          <field name="is_last_group_receiver" invisible="1" /><!--IMPORTANT -->

          <button name="action_send_response_to_prea" type="object" class="oe_highlight"
            string="Envoyer réponse" 
            confirm="Voulez vous envoyer la réponse au PREA?"
            statuts="state_traitement_pmo"
            attrs="{'invisible': [('statut', '!=', 'state_traitement_pmo')]}"/>
          
          <!--RETOUR DU TICKET: MAUVAIS DESTINATAIRE-->
          <button name="action_return_ticket_to_prea" type="object" class="btn btn-warning"
            string="Retour ticket" 
            confirm="Voulez vous renvoyer ce ticket au PREA (Cause: Mauvais destinataire) ?"
            statuts="state_traitement_pmo"
            attrs="{'invisible': [('has_response', '=', True)]}"/>

          <!-- Status bar -->
          <field name='statut' widget='statusbar' clickable="True" 
            statusbar_visible='state,state_validate_prea,state_traitement_pmo,state_eval_response_prea,state_send_response_bpo,state_done_bpo,state_invalid,state_closed_prea'/>
        </header>

        <sheet>
          <!-- Widget statinfo -->
          <div class="oe_button_box" name="button_box">
            <!-- Résultat -->
            <button name="get_result" type="object" class="oe_stat_button" icon="fa-thumbs-o-up text-success" style="width: 100px"
              attrs="{'invisible': [('resultat', '!=', 'satisfait')]}">
              <field name="result_display" widget="statinfo"/>
            </button>

            <button name="get_result" type="object" class="oe_stat_button" icon="fa-thumbs-o-down text-warning" style="width: 100px"
              attrs="{'invisible': [('resultat', '!=', 'insatisfait')]}">
              <field name="result_display" widget="statinfo"/>
            </button>

            <!-- Situation -->
            <button name="get_situation" type="object" class="oe_stat_button" icon="fa-phone text-success" style="width: 100px"
              attrs="{'invisible': [('situation', '!=', 'joignable')]}">
              <field name="situation_display" widget="statinfo"/>
            </button>

            <button name="get_situation" type="object" class="oe_stat_button" icon="fa-phone text-warning" style="width: 100px"
              attrs="{'invisible': [('situation', '!=', 'injoignable')]}">
              <field name="situation_display" widget="statinfo"/>
            </button>
            
            <!-- Nombre de jours de traitement -->
            <button name="get_jours_traitement" type="object" class="oe_stat_button" icon="fa-calendar text-warning" style="width: 200px">
              <field name="jours_traitement" widget="statinfo"/>
            </button>

            <!-- Status de réponse -->
            <button name="check_response" type="object" class="oe_stat_button" icon="fa-inbox text-info" style="width: 200px"
              attrs="{'invisible': [('response_complete', '=', False)]}">
              <field name="statut_response_display" string="Reponse envoyée" widget="statinfo"/>
            </button>

            <!-- Status du ticket -->
            <button name="get_statut" type="object" class="oe_stat_button" icon="fa-battery-quarter text-info"
              style="width: 200px" attrs="{'invisible': [('statut', '!=', 'state')]}">
              <field name="statut_display" widget="statinfo" clickable="False"/>
            </button>

            <button name="get_statut" type="object" class="oe_stat_button" icon="fa-battery-three-quarters text-info" 
                style="width: 200px" attrs="{'invisible': [('statut', '!=', 'state_validate_prea')]}">
              <field name="statut_display" widget="statinfo"/>
            </button>

            <button name="get_statut" type="object" class="oe_stat_button" icon="fa-battery-three-quarters text-info" 
                style="width: 200px" attrs="{'invisible': [('statut', '!=', 'state_traitement_pmo')]}">
              <field name="statut_display" widget="statinfo"/>
            </button>

            <button name="get_statut" type="object" class="oe_stat_button" icon="fa-battery-three-quarters text-info" 
                style="width: 200px" attrs="{'invisible': [('statut', '!=', 'state_eval_response_prea')]}">
              <field name="statut_display" widget="statinfo"/>
            </button>

            <button name="get_statut" type="object" class="oe_stat_button" icon="fa-battery-three-quarters text-info" 
                style="width: 200px" attrs="{'invisible': [('statut', '!=', 'state_send_response_bpo')]}">
              <field name="statut_display" widget="statinfo"/>
            </button>

            <button name="get_statut" type="object" class="oe_stat_button" icon="fa-battery-full text-success" 
              style="width: 200px" attrs="{'invisible': [('statut', '!=', 'state_done_bpo')]}">
              <field name="statut_display" widget="statinfo"/>
            </button>

            <button name="get_statut" type="object" class="oe_stat_button" icon="fa-window-close text-primary" 
              style="width: 200px" attrs="{'invisible': [('statut', '!=', 'state_closed_prea')]}">
              <field name="statut_display" widget="statinfo"/>
            </button>
            
            <button name="get_statut" type="object" class="oe_stat_button" icon="fa-ban text-danger" 
                style="width: 200px" attrs="{'invisible': [('statut', '!=', 'state_invalid')]}">
                <field name="statut_display" widget="statinfo"/>
            </button>
          </div>

          <!--RIBBON du ticket fermé-->
          <widget name="web_ribbon" text="FERMÉ" attrs="{'invisible': [('statut', '!=', 'state_closed_prea')]}" bg_color="bg-info"/>

          <!--RIBBON du ticket en cours de traitement-->
          <widget name="web_ribbon" text="EN TRAITEMENT" attrs="{'invisible': ['|', ('is_reprocessed', '=', True), ('statut', '!=', 'state_traitement_pmo' )]}" bg_color="bg-warning"/>
          <!-- <widget name="web_ribbon" text="EN COURS" attrs="{'invisible': ['|', ('is_reprocessed', '=', True), ('statut', 'in', ['state_closed_prea', 'state_done_bpo', 'state_invalid'])]}" bg_color="bg-warning"/> -->

          <!-- Title -->
          <div class="oe_title" position="before">
            <label for="reference" string="Ticket n°" />
            <h1><field name="reference"/></h1>
          </div>

          <!-- Fields -->
          <group>
            <group>
              <field name="date_appel" readonly="1" />
              <field name="genre" readonly="1" />
              <field name="education_id" readonly="1"
                options="{'no_create_edit': True, 'no_create': True, 'no_open': True}" />
              <field name="tranche_id" readonly="1"
                options="{'no_create_edit': True, 'no_create': True, 'no_open': True}" />
              <field name="langue" readonly="1" />
            </group>
            <group>
              <field name="region_id" readonly="1"
                options="{'no_create_edit': True, 'no_create': True, 'no_open': True}" /> 
              <field name="district_id" readonly="1"
                options="{'no_create_edit': True, 'no_create': True, 'no_open': True}" />
              <field name="commune_id" readonly="1" 
                options="{'no_create_edit': True, 'no_create': True, 'no_open': True}" />
              <field name="fokontany_id" readonly="1" 
                options="{'no_create_edit': True, 'no_create': True, 'no_open': True}" />
              <field name="composante_id" readonly="1"
                options="{'no_create_edit': True, 'no_create': True, 'no_open': True}" />
            </group>
          </group>

          <group>
            <field name="categorie_id" readonly="1"
                options="{'no_create_edit': True, 'no_create': True, 'no_open': True}" class="field_value_color"/>
            <field name="ennonce" string="Plainte/Doléance" readonly="1" widget="html" height="50" />
          </group>

          <notebook>
            <page name="Notes" string="Notes">
              <field name="note_ids" context="{'default_plainte_id':active_id}" widget="one2many_list" 
                attrs="{'readonly':['|',('statut', '!=', 'state_traitement_pmo'), ('statut', 'in', ['|', 'state','state_invalid','state_closed_prea'])]}">
                <tree editable="bottom">
                  <field name="plainte_id" invisible="1"/>
                  <field name="note" string="Notes"/>
                  <field name="create_uid" string="Par" readonly="1" />
                  <field name="create_date" string="Le" readonly="1" />
                  <field name="upload_file" filename="file_name"/>
                  <field name="file_name" invisible="1"/>
                </tree>
              </field>
            </page>

            <page name="Responses" string="Réponse" autofocus="autofocus">
              <field name="reponse_ids" context="{'default_plainte_id':active_id}" widget="one2many_list"
                attrs="{'readonly':['|', ('statut', '!=', 'state_traitement_pmo'), ('statut', 'in', ['|', 'state','state_invalid','state_closed_prea'])]}">
                <tree editable="bottom" delete="true">
                  <field name="plainte_id" invisible="1" />
                  <field name="reponse" class="tree_field_value" />
                  <field name="create_date" string="Le" readonly="1" />
                  <field name="upload_file" filename="file_name"/>
                  <field name="file_name" invisible="1"/>
                </tree>
              </field>
              <group>
                <field name="response_complete" attrs="{'readonly': [('statut', '!=', 'state_traitement_pmo')]}"/>
              </group>
            </page>

            <page name="Audit" string="Audit">
              <field name="log_ids" widget="many2many_list">
                <tree editable="bottom">
                  <field name="create_date" string="Date"/>
                  <field name="statut" string="Statut"/>
                  <field name="action"/>
                  <field name="group_sender_id" string="Par"/>
                  <field name="create_uid" string="Responsable"/>
                </tree>
              </field>
            </page>
          </notebook>
        </sheet>
        <!-- <div class="oe_chatter">
          <field name="message_follower_ids" widget="mail_followers"/>
          <field name="activity_ids" widget="mail_activity"/>
          <field name="message_ids" widget="mail_thread"/>
        </div> -->
      </form>
    </field>
  </record>

  <!-- View kanban -->
  <record id="plainte_pmo_kanban_view" model="ir.ui.view">
    <field name="name">plainte.pmo.kanban.view</field>
    <field name="model">mgp.plainte</field>
    <field name="arch" type="xml">
      <kanban default_group_by="statut" quick_create="false" class="o_kanban_project_tasks">
        <field name="genre" />
        <field name="is_last_group_receiver" />
        <field name="response_complete" />
        <field name="statut" />
        <field name="is_reprocessed" />
        <field name="categorie_wrap" />
        
        <progressbar
            field="statut"
            colors='{"state_traitement_pmo": "warning",
                    "state_closed_prea": "muted"}'/>
  
        <templates>
          <t t-name="kanban-box">
            <div class="oe_kanban_global_click mgp_kanban_tasks_ext" style="background-color: #EAF7F3;">
              <t t-if="record.genre.raw_value=='masculin'">
                <img class="o_kanban_image" alt="profile_male" t-att-src='_s + "/mgp/static/src/img/profile_male.png"' width="24"/>  
              </t>
              <t t-else="">
                <img class="o_kanban_image" alt="profile_female" t-att-src='_s + "/mgp/static/src/img/profile_female.png"' width="24"/>
              </t>
              <div class="oe_kanban_details">
                <div class="o_kanban_tags_section" />
                <strong><field name="reference" /></strong>
                <ul>
                  <li><span class="mgp_label fa fa-clock-o"><field name="date_appel"/></span></li>
                  <li><span class="mgp_label fa fa-map-marker"><field name="district_id"/></span></li>
                  <li><span class="mgp_label fa fa-commenting"><field name="categorie_wrap"/></span></li>
                  <li>
                    <t t-if="record.statut.raw_value=='state_done_bpo'">
                      <div class="ribbon-success"><p>Traité</p></div>
                    </t>
                    <t t-elif="record.statut.raw_value=='state_closed_prea'">
                      <div class="ribbon-closed"><p>Fermé</p></div>
                    </t>
                    <t t-elif="record.statut.raw_value=='state_invalid'">
                      <div class="ribbon-danger"><p>Invalide</p></div>
                    </t>
                    <t t-elif="record.response_complete.raw_value">
                      <t t-if="record.jours_traitement.raw_value>30">
                        <div class="ribbon-response space_right" title="Réponse complète">R</div><div class="ribbon-warning space_right">En cours</div><div class="ribbon-days-warning"><field name="jours_traitement"/>j</div>
                      </t>
                      <t t-else="">
                        <div class="ribbon-response space_right" title="Réponse complète">R</div><div class="ribbon-warning space_right">En cours</div><div class="ribbon-days"><field name="jours_traitement"/>j</div>                          
                      </t>
                    </t>
                    <t t-elif="record.statut.raw_value!='state'">
                      <t t-if="record.is_reprocessed.raw_value">
                        <t t-if="record.jours_traitement.raw_value>30">
                          <div class="ribbon-retraitement space_right">En retraitement</div><div class="ribbon-days-warning"><field name="jours_traitement"/>j</div>
                        </t>
                        <t t-else="">
                          <div class="ribbon-retraitement space_right">En retraitement</div><div class="ribbon-days"><field name="jours_traitement"/>j</div>
                        </t>
                      </t>
                      <t t-else="">
                        <t t-if="record.jours_traitement.raw_value>30">
                          <div class="ribbon-warning space_right">En cours </div><div class="ribbon-days-warning"><field name="jours_traitement"/>j</div>
                        </t>
                        <t t-else="">
                          <div class="ribbon-warning space_right">En cours </div><div class="ribbon-days"><field name="jours_traitement"/>j</div>
                        </t>
                      </t>
                    </t>
                  </li>
                </ul>
              </div>
            </div>
            <br/><br/>
          </t>
        </templates>
      </kanban>
    </field>
  </record>

  <!-- View Calendar -->
  <record id="plainte_pmo_calendar_view" model="ir.ui.view">
    <field name="name">plainte.calendar.view</field>
    <field name="model">mgp.plainte</field>
    <field name="arch" type="xml">
      <calendar string="Tickets" date_start="date_appel" mode="month" color="commune_id" quick_add="False"> 
        <field name="reference"/>
        <field name="categorie_id" options="{'no_open': True, 'no_create': True}"/>
        <field name="statut" class="text-warning"/>
        <field name="jours_traitement"/>
        <field name="response_complete"/>
      </calendar>
    </field>
  </record>

  <!-- View Graph -->
  <record id="plainte_pmo_graph_view" model="ir.ui.view">
    <field name="name">plainte.graph.view</field>
    <field name="model">mgp.plainte</field>
    <field name="arch" type="xml">
      <graph string="Par statut" type="bar"> <!--line, pie stacked="True"-->
        <field name="categorie_id"/>
        <field name="statut" type="row"/>    <!--row-->
      </graph>
    </field>
  </record>

  <!-- View Pivot -->
  <record id="plainte_pmo_pivot_view" model="ir.ui.view">
    <field name="name">plainte.pivot.view</field>
    <field name="model">mgp.plainte</field>
    <field name="arch" type="xml">
      <pivot string="Par statut">
        <field name="statut" type="col"/>
        <field name="categorie_id" type="row"/>
      </pivot>
    </field>
  </record>

  <!-- server action to the one above -->
  <record model="ir.actions.act_window" id="plainte_pmo_action_window">
    <field name="name">Traitement des plaintes</field>
    <field name="res_model">mgp.plainte</field>
    <field name="view_mode">kanban,tree,calendar,form</field>
    <field name="search_view_id" ref="plainte_pmo_view_search"/>
    <field name="domain">[('user_pmo_id', '=', uid), ('statut','in',['state_traitement_pmo', 'state_closed_prea']) ]</field>
    <field name="help" type="html">
      <p class="o_view_nocontent_smiling_face">
        Aucun ticket (plainte)
      </p><p>
        Une plainte pourrait être émise par tout opérateur acteur lié directement 
        ou indirectement dans la mise en œuvre du projet, en particulier par un citoyen.
      </p>
    </field>
  </record>

  <!-- My Specific kanban: plainte_pmo_kanban_view -->
  <record model="ir.actions.act_window.view" id="pmo_action_window_kanban">
    <field eval="1" name="sequence"/>
    <field name="view_mode">kanban</field>
    <field name="view_id" ref="plainte_pmo_kanban_view"/>
    <field name="act_window_id" ref="plainte_pmo_action_window"/>
  </record>

  <!-- My Specific Tree: plainte_pmo_list_view -->
  <record model="ir.actions.act_window.view" id="pmo_action_window_tree">
    <field eval="2" name="sequence"/>
    <field name="view_mode">tree</field>
    <field name="view_id" ref="plainte_pmo_list_view"/>
    <field name="act_window_id" ref="plainte_pmo_action_window"/>
  </record>

  <!-- My Specific Calendar: plainte_pmo_list_view -->
  <record model="ir.actions.act_window.view" id="pmo_action_window_calendar">
    <field eval="3" name="sequence"/>
    <field name="view_mode">calendar</field>
    <field name="view_id" ref="plainte_pmo_calendar_view"/>
    <field name="act_window_id" ref="plainte_pmo_action_window"/>
  </record>

  <!-- My Specific Form: plainte_pmo_form_view -->
  <record model="ir.actions.act_window.view" id="pmo_action_window_form">
    <field eval="4" name="sequence"/>
    <field name="view_mode">form</field>
    <field name="view_id" ref="plainte_pmo_form_view"/>
    <field name="act_window_id" ref="plainte_pmo_action_window"/>
  </record>

  <!-- My Specific Form: plainte_pmo_graph_view -->
  <record model="ir.actions.act_window.view" id="pmo_action_window_graph">
    <field eval="5" name="sequence"/>
    <field name="view_mode">graph</field>
    <field name="view_id" ref="plainte_pmo_graph_view"/>
    <field name="act_window_id" ref="plainte_pmo_action_window"/>
  </record>

  <!-- My Specific Form: plainte_pmo_pivot_view -->
  <record model="ir.actions.act_window.view" id="pmo_action_window_pivot">
    <field eval="6" name="sequence"/>
    <field name="view_mode">pivot</field>
    <field name="view_id" ref="plainte_pmo_pivot_view"/>
    <field name="act_window_id" ref="plainte_pmo_action_window"/>
  </record>

</odoo>
